https://cwiki.apache.org/confluence/display/NIFI/Migration+Guidance#MigrationGuidance-Migratingto2.0.0-M4
### **一、NiFi 1.26 与 2.0.0-M4 不兼容变更对比表**

| **变更领域**        | **NiFi 1.26**   | **NiFi 2.0.0-M4**           | **不兼容性影响**                                                       |
| --------------- | --------------- | --------------------------- | ---------------------------------------------------------------- |
| **Java 版本要求**   | Java 8+         | **Java 17+**                | 需升级JDK版本，否则无法启动。                                                 |
| **FlowFile 版本** | 使用旧版序列化格式       | 引入新版FlowFile格式（V3）          | 旧版本流程需转换，直接导入可能导致数据不一致。                                          |
| **权限模型**        | 基于角色的访问控制（RBAC） | **细粒度策略驱动权限（Policy-Based）** | 旧权限配置需重新适配新模型，用户/组策略需手动迁移。                                       |
| **依赖库升级**       | 部分旧版库（如Jetty 9） | 升级至Jetty 10+、Spring 6等      | 自定义扩展（如NAR包）若依赖旧库可能需重新编译。                                        |
| **处理器/组件变更**    | 部分处理器标记为废弃      | 移除或重构废弃组件（如`ExecuteSQL`）    | 使用废弃处理器的流程将无法加载，需替换为替代组件。                                        |
| **REST API 变更** | API路径和参数兼容1.x   | **部分API路径/参数调整**            | 调用旧版API的脚本或工具需适配新接口（如`/process-groups`改为`/flow/process-groups`）。 |
| **加密机制**        | 支持JCE方式加密       | 强制使用**AES-GCM**加密           | 旧加密配置需迁移密钥，否则无法解密敏感属性。                                           |
| **UI 框架**       | 基于AngularJS     | 迁移至现代前端框架（如React）           | 自定义UI扩展需重构，旧版主题可能不兼容。                                            |

### **二、升级到 NiFi 2.x 的详细指南**

#### **1. 预升级准备**

- **环境检查**
    
    - 确认JDK版本 ≥17，安装兼容的JVM。
        
    - 备份现有`flow.xml.gz`、`authorizations.xml`、`用户库及自定义NAR包`。
        
- **组件兼容性检查**
    
    - 使用`nifi-toolkit`的`cli.sh`执行`flow-analyzer`，识别废弃处理器和过期配置。
        
    - 替换标记为废弃的组件（如`ExecuteScript`改用Python或新版脚本引擎）。
        

#### **2. 权限模型迁移**

- **策略配置迁移**
    
    - 通过REST API导出旧权限配置（`/policies`），按新策略格式手动映射。
        
    - 使用`admin`账户重新分配细粒度策略（如数据访问、操作权限分离）。
        

#### **3. 流程升级**

- **FlowFile 格式转换**
    
    - 使用`nifi-toolkit`的`FlowFileConverter`工具将旧版流程转换为V3格式。
        
    - 验证转换后流程的完整性（如连接关系、敏感属性加密状态）。

#### **4. 加密配置迁移**

- **密钥库更新**
    
    - 生成新的AES-GCM密钥并更新`nifi.properties`中的`nifi.sensitive.props.key`。
        
    - 使用`encrypt-config.sh`工具迁移敏感属性至新加密机制。
        

#### **5. 自定义扩展适配**

- **NAR包重编译**
    
    - 检查依赖库（如Jetty、Spring）是否兼容NiFi 2.x，必要时更新POM依赖。
        
    - 重新编译并替换旧版NAR包，部署至`lib`目录。
        

#### **6. 升级后验证**

- **逐步启动验证**
    
    - 启动NiFi 2.x并监控日志（关注`ERROR`级日志）。
        
    - 验证核心功能：流程执行、数据路由、权限控制、API调用。
        
    - 测试自定义处理器/服务，确保无`ClassNotFoundException`等兼容性错误。


#### **. 回滚方案**

- 保留NiFi 1.x安装目录及备份文件，若升级失败可快速回退至旧版本。
    

---

### **三、关键注意事项**

1. **API 客户端适配**
    
    - 更新自动化脚本或第三方工具（如监控系统）至兼容NiFi 2.x的API路径。
        
2. **UI 自定义项**
    
    - 若曾修改AngularJS模板或CSS，需基于React框架重构UI组件。
        
3. **集群升级**
    
    - 采用滚动升级策略，逐个节点升级并确保数据同步正常。
        

---

通过以上步骤，可系统化完成从NiFi 1.x到2.x的升级，最大限度减少停机风险。建议在测试环境充分验证后再进行生产环境部署。



## 迁移过时组件和特性
https://cwiki.apache.org/confluence/display/NIFI/Migrating+Deprecated+Components+and+Features+for+2.0.0

Apache NiFi 2.0.0版本包含了对多个已废弃的扩展组件和遗留产品功能的移除。1.18.0版本引入了废弃日志记录功能，用于为那些计划要被移除的元素提供运行时警告。升级到最新的1版本发布能够提供最准确的一组废弃警告。
- **配置变更必须在从版本1升级之前完成，以避免失败。**
- **解释**：在升级到新版本之前，需要先完成相关的配置更改。这是因为新版本可能对某些配置项有新的要求或格式，如果在升级后再去修改配置，可能会导致系统无法正常运行，出现各种错误和失败的情况。例如，某些配置项可能在新版本中已经被弃用或修改了默认值，提前完成配置变更可以确保系统在升级后能够按照预期工作。
**应用程序设置和流程设计更改应在升级到版本2之前完成并测试**

- **应用程序设置和流程设计更改应在升级到版本2之前完成并测试。**
**从弃用的组件和特性迁移需要根据配置的属性采取不同的步骤**
当需要从旧版本中已经标记为弃用的组件和特性迁移到新的替代方案时，具体的迁移步骤会因配置的属性不同而有所差异。不同的组件和特性可能涉及到不同的配置项和参数，这些配置项在迁移过程中可能需要进行调整或替换，以确保在新版本中能够实现类似的功能和行为。例如，某些组件可能依赖特定的配置属性来控制其行为，而在迁移时，可能需要找到新的属性或配置方式来替代旧的配置，以保持功能的一致性。
- **迁移的难度会根据需要更改的属性数量以及维持类似行为所涉及的步骤而有所不同。**


### 1.  特性
迁移已弃用的功能需要对应用程序属性或自定义组件实现进行更改，所涉及的步骤将根据实现细节和部署用例而有所不同
|   |   |
|---|---|

|Component|org.apache.nifi.encrypt.PropertyEncryptorBuilder|
|Bundle Group|org.apache.nifi|
|Bundle Artifact|nifi-property-encryptor|
|Deprecation Type|Allowed Values|
|Deprecated Version|1.21.0|
|Migration Difficulty|LOW|
|Migration Type|Property Update|



## 官网升级步骤
以下说明是从 1.x.0 版本升级到另一版本时应遵循的一般步骤。
在升级之前，您应仔细阅读ReleaseNote，以确保您了解新版本中的变更及其对现有数据流和/或环境可能产生的影响。此外，请查看 “迁移指南 ”页面，了解在特定 NiFi 版本之间迁移时应注意的事项。

|     |                                                        |
| --- | ------------------------------------------------------ |
|     | 集群中的所有节点都必须升级到相同的 NiFi 版本，因为在同一个集群中不支持具有不同 NiFi 版本的节点。 |
### 保留自定义处理器
如果您有任何自定义 NAR，请按以下方法将其集中存储，以便在升级过程中保留它们：

1. 创建名为 custom_lib 的第二个库目录。
2. 将自定义 NAR 移到这个新的 lib 目录中。
3. 在 nifi.properties 文件中添加一行新内容，指定这个新的库目录：
```properties
nifi.nar.library.directory=./lib
nifi.nar.library.directory.custom=/opt/configuration_resources/custom_lib
```



# NiFi后续的兼容性考虑
NiFi中不兼容的场景：
-  处理器属性被删减
- 处理器废弃
- 处理器的bundle信息改了，如类型名称/包路径等。
第一种情况的处理策略：   过时的属性删减，提前限制用户可以选择的配置，在实例化任务的时候直接删除不支持配置的属性。但是需要测试这种情况能否被创建。

第二种情况的处理策略： 迁移



1、避免用户滥用未开放的处理器，应该严格控制用户可选的Processor，有两种方案：
	-  在nifi源码中删除未开放的处理器
	-  将已经开放的处理器信息保存在数据库中
	需要考虑后续用户自定义处理器后，信息如何注册，保存在哪里


2、 已经开放的处理器需要严格限制用户可配制的属性，如果在NiFi中已经标注了@Deprecated注解的属性，不允许用户配置。每个处理器可配制属性也需要存储在数据库中。
对于已经开放的配置属性，后续要保持兼容，可以通过修改nifi源码的方式处理。

3、提供处理器校验SDK，每个处理器都需要做一层自己的校验逻辑